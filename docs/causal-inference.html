<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Causal Inference | GT</title>
  <meta name="description" content="5 Causal Inference | GT" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Causal Inference | GT" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Causal Inference | GT" />
  
  
  

<meta name="author" content="Katherine Wilson and Jess Huang" />


<meta name="date" content="2022-02-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="descriptive-analysis.html"/>
<link rel="next" href="geospatial-analysis.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Gifted and Talented</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="motivation.html"><a href="motivation.html"><i class="fa fa-check"></i><b>2</b> Motivation</a></li>
<li class="chapter" data-level="3" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html"><i class="fa fa-check"></i><b>3</b> Assumptions/Notations</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#review-of-ate-and-fundamental-problem"><i class="fa fa-check"></i><b>3.0.1</b> Review of ATE and Fundamental Problem</a></li>
<li class="chapter" data-level="3.0.2" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#graphical-causal-models"><i class="fa fa-check"></i><b>3.0.2</b> Graphical Causal Models</a></li>
<li class="chapter" data-level="3.0.3" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#sutva-assumption"><i class="fa fa-check"></i><b>3.0.3</b> SUTVA Assumption</a></li>
<li class="chapter" data-level="3.0.4" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#ignorability-assumption"><i class="fa fa-check"></i><b>3.0.4</b> Ignorability Assumption</a></li>
<li class="chapter" data-level="3.0.5" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#further-notes-on-assumptions"><i class="fa fa-check"></i><b>3.0.5</b> Further notes on assumptions</a></li>
<li class="chapter" data-level="3.0.6" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#regression-adjustment"><i class="fa fa-check"></i><b>3.0.6</b> Regression Adjustment</a></li>
<li class="chapter" data-level="3.0.7" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#iptw"><i class="fa fa-check"></i><b>3.0.7</b> IPTW</a></li>
<li class="chapter" data-level="3.0.8" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#bart"><i class="fa fa-check"></i><b>3.0.8</b> BART</a></li>
<li class="chapter" data-level="3.0.9" data-path="assumptionsnotations.html"><a href="assumptionsnotations.html#att-vs.-ate"><i class="fa fa-check"></i><b>3.0.9</b> ATT vs. ATE</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="descriptive-analysis.html"><a href="descriptive-analysis.html"><i class="fa fa-check"></i><b>4</b> Descriptive Analysis</a>
<ul>
<li class="chapter" data-level="4.0.1" data-path="descriptive-analysis.html"><a href="descriptive-analysis.html#data-cleaning"><i class="fa fa-check"></i><b>4.0.1</b> Data cleaning</a></li>
<li class="chapter" data-level="4.0.2" data-path="descriptive-analysis.html"><a href="descriptive-analysis.html#visualizing-the-treatment-gt-option"><i class="fa fa-check"></i><b>4.0.2</b> Visualizing the Treatment (GT option)</a></li>
<li class="chapter" data-level="4.0.3" data-path="descriptive-analysis.html"><a href="descriptive-analysis.html#raw-differences-in-outcome-and-covariates"><i class="fa fa-check"></i><b>4.0.3</b> Raw Differences in Outcome and Covariates</a></li>
<li class="chapter" data-level="4.0.4" data-path="descriptive-analysis.html"><a href="descriptive-analysis.html#correlation-of-covariates"><i class="fa fa-check"></i><b>4.0.4</b> Correlation of covariates</a></li>
<li class="chapter" data-level="4.0.5" data-path="descriptive-analysis.html"><a href="descriptive-analysis.html#naive-regression-models-without-matching"><i class="fa fa-check"></i><b>4.0.5</b> Naive regression models (without matching)</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="causal-inference.html"><a href="causal-inference.html"><i class="fa fa-check"></i><b>5</b> Causal Inference</a>
<ul>
<li class="chapter" data-level="5.0.1" data-path="causal-inference.html"><a href="causal-inference.html#matching"><i class="fa fa-check"></i><b>5.0.1</b> Matching</a></li>
<li class="chapter" data-level="5.0.2" data-path="causal-inference.html"><a href="causal-inference.html#specification-of-the-ps-model-with-machine-learning"><i class="fa fa-check"></i><b>5.0.2</b> Specification of the PS Model with Machine Learning</a></li>
<li class="chapter" data-level="5.0.3" data-path="causal-inference.html"><a href="causal-inference.html#survey-design-and-ipw-for-the-outcome-model"><i class="fa fa-check"></i><b>5.0.3</b> Survey Design and IPW for the Outcome Model</a></li>
<li class="chapter" data-level="5.0.4" data-path="causal-inference.html"><a href="causal-inference.html#doubly-robust-methods"><i class="fa fa-check"></i><b>5.0.4</b> Doubly Robust Methods</a></li>
<li class="chapter" data-level="5.0.5" data-path="causal-inference.html"><a href="causal-inference.html#heterogeneous-treatment-effects"><i class="fa fa-check"></i><b>5.0.5</b> Heterogeneous Treatment Effects</a></li>
<li class="chapter" data-level="5.0.6" data-path="causal-inference.html"><a href="causal-inference.html#within-borough-matching"><i class="fa fa-check"></i><b>5.0.6</b> Within Borough Matching</a></li>
<li class="chapter" data-level="5.0.7" data-path="causal-inference.html"><a href="causal-inference.html#outcome-models"><i class="fa fa-check"></i><b>5.0.7</b> Outcome Models</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="geospatial-analysis.html"><a href="geospatial-analysis.html"><i class="fa fa-check"></i><b>6</b> GeoSpatial Analysis</a></li>
<li class="chapter" data-level="7" data-path="simulation-and-loops.html"><a href="simulation-and-loops.html"><i class="fa fa-check"></i><b>7</b> Simulation and Loops</a>
<ul>
<li class="chapter" data-level="7.0.1" data-path="simulation-and-loops.html"><a href="simulation-and-loops.html#ate-results-loop"><i class="fa fa-check"></i><b>7.0.1</b> ATE results Loop</a></li>
<li class="chapter" data-level="7.0.2" data-path="simulation-and-loops.html"><a href="simulation-and-loops.html#group-structured-data-when-the-data-has-a-multilevel-structure"><i class="fa fa-check"></i><b>7.0.2</b> Group structured data (when the data has a multilevel structure)</a></li>
<li class="chapter" data-level="7.0.3" data-path="simulation-and-loops.html"><a href="simulation-and-loops.html#estimators"><i class="fa fa-check"></i><b>7.0.3</b> Estimators</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">GT</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="causal-inference" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Causal Inference</h1>
<div id="matching" class="section level3" number="5.0.1">
<h3><span class="header-section-number">5.0.1</span> Matching</h3>
<p>Given that the groups are imbalanced (GT option schools are more likely to be high income, less SWD, more students), can we balance the groups to get the ATE of the GT option on ELA and MATH scores?</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="causal-inference.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-2"><a href="causal-inference.html#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="causal-inference.html#cb1-3" aria-hidden="true" tabindex="-1"></a>school_nearest <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treatment <span class="sc">~</span> PercentBlack <span class="sc">+</span> PercentSWD <span class="sc">+</span> PercentPoverty <span class="sc">+</span> TotalEnrollment <span class="sc">+</span></span>
<span id="cb1-4"><a href="causal-inference.html#cb1-4" aria-hidden="true" tabindex="-1"></a>                          ENI, </span>
<span id="cb1-5"><a href="causal-inference.html#cb1-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> <span class="fu">binomial</span>(),</span>
<span id="cb1-6"><a href="causal-inference.html#cb1-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> small,</span>
<span id="cb1-7"><a href="causal-inference.html#cb1-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">method =</span> <span class="st">&quot;nearest&quot;</span>,</span>
<span id="cb1-8"><a href="causal-inference.html#cb1-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">caliper =</span> <span class="fl">0.25</span>,</span>
<span id="cb1-9"><a href="causal-inference.html#cb1-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ratio =</span> <span class="dv">3</span>)</span>
<span id="cb1-10"><a href="causal-inference.html#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="causal-inference.html#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#create the matched set</span></span>
<span id="cb1-12"><a href="causal-inference.html#cb1-12" aria-hidden="true" tabindex="-1"></a>nearest_matched <span class="ot">&lt;-</span> <span class="fu">match.data</span>(school_nearest)</span>
<span id="cb1-13"><a href="causal-inference.html#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span></code></pre></div>
<pre><code>##  cobalt (Version 4.3.2, Build Date: 2022-01-19)</code></pre>
<pre><code>## 
## Attaching package: &#39;cobalt&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:MatchIt&#39;:
## 
##     lalonde</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="causal-inference.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(school_nearest, <span class="at">m.threshold =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<pre><code>## Call
##  matchit(formula = treatment ~ PercentBlack + PercentSWD + PercentPoverty + 
##     TotalEnrollment + ENI, data = small, method = &quot;nearest&quot;, 
##     caliper = 0.25, ratio = 3, family = binomial())
## 
## Balance Measures
##                     Type Diff.Adj    M.Threshold
## distance        Distance   0.0136 Balanced, &lt;0.1
## PercentBlack     Contin.  -0.0387 Balanced, &lt;0.1
## PercentSWD       Contin.   0.0154 Balanced, &lt;0.1
## PercentPoverty   Contin.  -0.0666 Balanced, &lt;0.1
## TotalEnrollment  Contin.  -0.0370 Balanced, &lt;0.1
## ENI              Contin.  -0.0664 Balanced, &lt;0.1
## 
## Balance tally for mean differences
##                    count
## Balanced, &lt;0.1         6
## Not Balanced, &gt;0.1     0
## 
## Variable with the greatest mean difference
##        Variable Diff.Adj    M.Threshold
##  PercentPoverty  -0.0666 Balanced, &lt;0.1
## 
## Sample sizes
##                      Control Treated
## All                  1009.       101
## Matched (ESS)         256.79      99
## Matched (Unweighted)  280.        99
## Unmatched             729.         2</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="causal-inference.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(school_nearest, <span class="at">var.name =</span> <span class="st">&#39;TotalEnrollment&#39;</span>, <span class="at">which =</span> <span class="st">&quot;both&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="causal-inference.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(school_nearest, <span class="at">var.name =</span> <span class="st">&#39;PercentPoverty&#39;</span>, <span class="at">which =</span> <span class="st">&quot;both&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="causal-inference.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(school_nearest, <span class="at">var.name =</span> <span class="st">&#39;PercentBlack&#39;</span>, <span class="at">which =</span> <span class="st">&quot;both&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-2-3.png" width="672" /></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="causal-inference.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(school_nearest, <span class="at">var.name =</span> <span class="st">&#39;PercentSWD&#39;</span>, <span class="at">which =</span> <span class="st">&quot;both&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-2-4.png" width="672" /></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="causal-inference.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(school_nearest, <span class="at">var.name =</span> <span class="st">&#39;ENI&#39;</span>, <span class="at">which =</span> <span class="st">&quot;both&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-2-5.png" width="672" /></p>
<p><span class="math display">\[
\begin{align}
ELA_scores = \beta_0 +\beta_1GTOption + \epsilon
\end{align}
\]</span></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="causal-inference.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb12-2"><a href="causal-inference.html#cb12-2" aria-hidden="true" tabindex="-1"></a>nearest_matched <span class="ot">&lt;-</span> <span class="fu">match.data</span>(school_nearest)</span>
<span id="cb12-3"><a href="causal-inference.html#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="causal-inference.html#cb12-4" aria-hidden="true" tabindex="-1"></a>model_n <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="st">`</span><span class="at">3 2019.math</span><span class="st">`</span> <span class="sc">~</span> treatment, <span class="at">data =</span> nearest_matched)</span>
<span id="cb12-5"><a href="causal-inference.html#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_n)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = `3 2019.math` ~ treatment, data = nearest_matched)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -21.4595  -6.4595  -0.4141   6.5405  29.5405 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 603.4595     0.6828  883.85  &lt; 2e-16 ***
## treatment     3.9547     1.1564    3.42 0.000719 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 9.287 on 282 degrees of freedom
##   (95 observations deleted due to missingness)
## Multiple R-squared:  0.03982,    Adjusted R-squared:  0.03642 
## F-statistic: 11.69 on 1 and 282 DF,  p-value: 0.0007193</code></pre>
</div>
<div id="specification-of-the-ps-model-with-machine-learning" class="section level3" number="5.0.2">
<h3><span class="header-section-number">5.0.2</span> Specification of the PS Model with Machine Learning</h3>
<div id="tree-approaches-gbm-and-bart" class="section level4" number="5.0.2.1">
<h4><span class="header-section-number">5.0.2.1</span> Tree Approaches: GBM and BART</h4>
<p>Without information on the true parametric form of the response surface (i.e. covariates could be related to outcome not linearly), flexible modeling approaches like bart help to account for uncertainty in the data. BART is a sum-of-trees and a regularization prior. BART can be used to fit highly nonlinear response surfaces.</p>
<p>BART can be used to estimate the ATE. First, fit BART to observed data (ELA given Treatment and X). Then make predictions for two datasets. Covariates (X) are intact for both datasets, so BART draws from the posterior distributions of <span class="math inline">\(E[Y(1) |X] and E[Y(0) |x]\)</span> for each person, as well as <span class="math inline">\(E[Y(1) - Y(0)|X] and E[Y(0) |x]\)</span>. These posterior distributions for individual level treatment effects are then aggregated to obtain posterior distributions of ATE.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="causal-inference.html#cb14-1" aria-hidden="true" tabindex="-1"></a>school.balance <span class="ot">&lt;-</span> <span class="fu">bal.table</span>(ps.school.gbm)</span>
<span id="cb14-2"><a href="causal-inference.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ps.school.gbm, <span class="at">plots =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="causal-inference.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ps.school.gbm, <span class="at">plots =</span> <span class="dv">4</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-5-2.png" width="672" /></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="causal-inference.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## relative importance plots (relationship between the covariates and the treatment assignment)</span></span>
<span id="cb16-2"><a href="causal-inference.html#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="causal-inference.html#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ps.school.gbm<span class="sc">$</span>gbm.obj, </span>
<span id="cb16-4"><a href="causal-inference.html#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-5-3.png" width="672" /></p>
<pre><code>##                             var  rel.inf
## PercentSWD           PercentSWD 25.27703
## PercentPoverty   PercentPoverty 24.94303
## TotalEnrollment TotalEnrollment 20.19330
## ENI                         ENI 16.79533
## PercentBlack       PercentBlack 12.79131</code></pre>
</div>
</div>
<div id="survey-design-and-ipw-for-the-outcome-model" class="section level3" number="5.0.3">
<h3><span class="header-section-number">5.0.3</span> Survey Design and IPW for the Outcome Model</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="causal-inference.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">### analysis of outcomes, perform the outcome analysis with weights (using the survey package)</span></span>
<span id="cb18-2"><a href="causal-inference.html#cb18-2" aria-hidden="true" tabindex="-1"></a>small<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="fu">get.weights</span>(ps.school.gbm, <span class="at">stop.method=</span><span class="st">&quot;es.mean&quot;</span>)</span>
<span id="cb18-3"><a href="causal-inference.html#cb18-3" aria-hidden="true" tabindex="-1"></a>design.ps <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>w, <span class="at">data=</span>small)</span>
<span id="cb18-4"><a href="causal-inference.html#cb18-4" aria-hidden="true" tabindex="-1"></a>glm1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(<span class="fu">as.numeric</span>(<span class="st">`</span><span class="at">3 2019.math</span><span class="st">`</span>) <span class="sc">~</span> treatment, <span class="at">design=</span>design.ps)</span>
<span id="cb18-5"><a href="causal-inference.html#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm1)</span></code></pre></div>
<pre><code>## 
## Call:
## svyglm(formula = as.numeric(`3 2019.math`) ~ treatment, design = design.ps)
## 
## Survey design:
## svydesign(ids = ~1, weights = ~w, data = small)
## 
## Coefficients:
##             Estimate Std. Error  t value Pr(&gt;|t|)    
## (Intercept) 603.5650     0.5256 1148.274  &lt; 2e-16 ***
## treatment     4.3162     1.0648    4.054 5.55e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 97.82262)
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="causal-inference.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## increase in MATH scores of 4 points for those in a GT school</span></span></code></pre></div>
</div>
<div id="doubly-robust-methods" class="section level3" number="5.0.4">
<h3><span class="header-section-number">5.0.4</span> Doubly Robust Methods</h3>
<p>Use both PS adjustment and covariate adjustment for “doubly robust” method. These estimators are consistent if either the PS are estimated correctly or the regression model is specificed correctly. See that there are still differences, despite balancing. So, include other covariates in the outcome model that reduces the SE of the treatment, especially if some of these covaraites are strongly related to the outcome.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="causal-inference.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## the SE decreasees </span></span>
<span id="cb21-2"><a href="causal-inference.html#cb21-2" aria-hidden="true" tabindex="-1"></a>glm2 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(<span class="fu">as.numeric</span>(<span class="st">`</span><span class="at">3 2019.math</span><span class="st">`</span>) <span class="sc">~</span> treatment <span class="sc">+</span> PercentSWD, <span class="at">design=</span>design.ps)</span>
<span id="cb21-3"><a href="causal-inference.html#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm2)</span></code></pre></div>
<pre><code>## 
## Call:
## svyglm(formula = as.numeric(`3 2019.math`) ~ treatment + PercentSWD, 
##     design = design.ps)
## 
## Survey design:
## svydesign(ids = ~1, weights = ~w, data = small)
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 619.7429     1.8877 328.309   &lt;2e-16 ***
## treatment     2.8284     0.8822   3.206   0.0014 ** 
## PercentSWD  -89.3529     9.7375  -9.176   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 68.17794)
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="causal-inference.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## we can adjust for more, but these have little effect on the estimated program effect</span></span>
<span id="cb23-2"><a href="causal-inference.html#cb23-2" aria-hidden="true" tabindex="-1"></a>glm3 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(<span class="fu">as.numeric</span>(<span class="st">`</span><span class="at">3 2019.math</span><span class="st">`</span>) <span class="sc">~</span> treatment <span class="sc">+</span> PercentSWD <span class="sc">+</span></span>
<span id="cb23-3"><a href="causal-inference.html#cb23-3" aria-hidden="true" tabindex="-1"></a>                 PercentBlack <span class="sc">+</span> TotalEnrollment, <span class="at">design=</span>design.ps)</span>
<span id="cb23-4"><a href="causal-inference.html#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm3)</span></code></pre></div>
<pre><code>## 
## Call:
## svyglm(formula = as.numeric(`3 2019.math`) ~ treatment + PercentSWD + 
##     PercentBlack + TotalEnrollment, design = design.ps)
## 
## Survey design:
## svydesign(ids = ~1, weights = ~w, data = small)
## 
## Coefficients:
##                   Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)     625.256657   2.526922 247.438  &lt; 2e-16 ***
## treatment         3.345846   0.842622   3.971 7.83e-05 ***
## PercentSWD      -84.127395   9.479015  -8.875  &lt; 2e-16 ***
## PercentBlack    -13.432339   2.154439  -6.235 7.45e-10 ***
## TotalEnrollment  -0.006088   0.001939  -3.139  0.00176 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 58.25097)
## 
## Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div id="heterogeneous-treatment-effects" class="section level3" number="5.0.5">
<h3><span class="header-section-number">5.0.5</span> Heterogeneous Treatment Effects</h3>
</div>
<div id="within-borough-matching" class="section level3" number="5.0.6">
<h3><span class="header-section-number">5.0.6</span> Within Borough Matching</h3>
</div>
<div id="outcome-models" class="section level3" number="5.0.7">
<h3><span class="header-section-number">5.0.7</span> Outcome Models</h3>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="descriptive-analysis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="geospatial-analysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/YOUR GITHUB USERNAME/YOUR REPO NAME/edit/master/05-causal_analysis.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/YOUR GITHUB USERNAME/YOUR REPO NAME/blob/master/05-causal_analysis.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
